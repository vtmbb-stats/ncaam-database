<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D1 Transfer Portal Watchlist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .conference-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .conference-tabs button {
            padding: 8px 16px;
            background: white;
            color: #333;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .conference-tabs button:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .conference-tabs button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .conference-tabs button.active:hover {
            background: #0056b3;
            border-color: #0056b3;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .filters input, .filters select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filters button {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .filters button:hover {
            background: #218838;
        }

        .active-filters {
            margin-bottom: 15px;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .filter-row select, .filter-row input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .filter-row select {
            min-width: 100px;
        }

        .filter-row input[type="number"] {
            width: 80px;
        }

        .filter-row button {
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .filter-row button:hover {
            background: #c82333;
        }

        .stats {
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #f8f9fa;
            padding: 10px 8px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            cursor: pointer;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:hover {
            background: #e9ecef;
        }

        td {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        tr.marked {
            background: #fff3cd;
        }

        tr.marked:hover {
            background: #ffe69c;
        }

        tr.marked-star {
            background: #fff8dc;
            border-left: 3px solid #ffc107;
        }

        tr.marked-star:hover {
            background: #ffecb3;
        }

        tr.marked-x {
            background: #ffe6e6;
            border-left: 3px solid #dc3545;
        }

        tr.marked-x:hover {
            background: #ffcccc;
        }

        .mark-button {
            background: none;
            border: 1px solid #ddd;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 3px;
        }

        .mark-button:hover {
            background: #f0f0f0;
        }

        button {
            padding: 5px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        button:hover {
            background: #0056b3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-content h2 {
            margin-bottom: 20px;
        }

        .existing-notes {
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            flex: 1;
        }

        .note {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 14px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .note-text {
            margin-top: 5px;
            white-space: pre-wrap;
        }

        .add-note {
            margin-top: 20px;
        }

        .add-note select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .add-note textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 80px;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .add-note button {
            margin-right: 10px;
        }

        input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>D1 Transfer Portal Watchlist</h1>
        
        <h3>Conference</h3>
        <div class="conference-tabs" id="conferenceTabs">
            <!-- Conference buttons will be added here -->
        </div>

        <div style="margin-bottom: 15px;">
            <strong>Show Only:</strong>
            <button id="showAll" onclick="filterByMark('all')" style="background: #6c757d; margin-left: 10px;">All Players</button>
            <button id="showStars" onclick="filterByMark('star')" style="background: #ffc107; color: #000;">⭐ Stars</button>
            <button id="showXs" onclick="filterByMark('x')" style="background: #dc3545;">❌ X's</button>
        </div>

        <div class="filters">
            <input type="text" id="nameFilter" placeholder="Search name...">
            <input type="text" id="schoolFilter" placeholder="Search school...">
            <button id="addFilterBtn" onclick="addFilterRow()">+ Add Filter</button>
        </div>

        <div id="activeFilters" class="active-filters">
            <!-- Dynamic filter rows will appear here -->
        </div>

        <div class="stats" id="stats">Loading...</div>

        <div class="table-container">
            <table id="playersTable">
                <thead>
                    <tr>
                        <th>Mark</th>
                        <th data-sort="Name">Name</th>
                        <th data-sort="POS">Pos</th>
                        <th data-sort="Class">Class</th>
                        <th data-sort="Height">Ht</th>
                        <th data-sort="Weight">Wt</th>
                        <th data-sort="School">School</th>
                        <th data-sort="Conference">Conf</th>
                        <th data-sort="Record">Record</th>
                        <th data-sort="GP">GP</th>
                        <th data-sort="MIN">MIN</th>
                        <th data-sort="PPG">PPG ↓</th>
                        <th data-sort="RPG">RPG</th>
                        <th data-sort="APG">APG</th>
                        <th data-sort="SPG">SPG</th>
                        <th data-sort="BPG">BPG</th>
                        <th data-sort="TOPG">TO</th>
                        <th data-sort="FG%">FG%</th>
                        <th data-sort="FT%">FT%</th>
                        <th data-sort="3P%">3P%</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="20" class="loading">Loading players...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="notesModal">
        <div class="modal-content">
            <h2 id="modalTitle">Player Notes</h2>
            <div class="existing-notes" id="existingNotes"></div>
            <div class="add-note">
                <select id="noteAuthor">
                    <option>David Moats</option>
                    <option>Aidan Berry</option>
                    <option>Dean Breeden</option>
                    <option>Richie Brooker</option>
                    <option>Nick Capeci</option>
                    <option>Baker Dean</option>
                    <option>Nate Hensley</option>
                    <option>David Kebede</option>
                    <option>Bryan Peyton</option>
                    <option>Aaron Purser</option>
                    <option>Isaac Yeaker</option>
                </select>
                <textarea id="noteText" placeholder="Add a note..."></textarea>
                <button onclick="addNote()">Add Note</button>
                <button onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBBxeVddki46ufueCLObIVnE9egZKY7IZ8",
            authDomain: "ncaam-database.firebaseapp.com",
            projectId: "ncaam-database",
            storageBucket: "ncaam-database.firebasestorage.app",
            messagingSenderId: "1034210448770",
            appId: "1:1034210448770:web:d620e8559a646da80a6b9b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make these global so onclick handlers work
        window.db = db;
        window.getDocs = getDocs;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;

        let allPlayers = [];
        let filteredPlayers = [];
        let playerNotes = {};
        let markedPlayers = {};
        let currentSort = { key: 'PPG', direction: 'desc' };
        let selectedPlayer = null;
        let currentConference = 'ACC';
        let conferences = [];
        let dynamicFilters = [];
        let filterIdCounter = 0;
        let markFilter = 'all'; // 'all', 'star', or 'x'

        const STAT_OPTIONS = [
            { value: 'POS', label: 'Position', type: 'string' },
            { value: 'Class', label: 'Class', type: 'string' },
            { value: 'Height', label: 'Height', type: 'number' },
            { value: 'Weight', label: 'Weight', type: 'number' },
            { value: 'Record', label: 'Win %', type: 'number' },
            { value: 'GP', label: 'Games Played', type: 'number' },
            { value: 'MIN', label: 'Minutes', type: 'number' },
            { value: 'PPG', label: 'Points', type: 'number' },
            { value: 'RPG', label: 'Rebounds', type: 'number' },
            { value: 'APG', label: 'Assists', type: 'number' },
            { value: 'SPG', label: 'Steals', type: 'number' },
            { value: 'BPG', label: 'Blocks', type: 'number' },
            { value: 'TOPG', label: 'Turnovers', type: 'number' },
            { value: 'FG%', label: 'FG%', type: 'number' },
            { value: 'FT%', label: 'FT%', type: 'number' },
            { value: '3P%', label: '3P%', type: 'number' }
        ];

        // Make add filter functions global
        window.addFilterRow = function() {
            const filterId = filterIdCounter++;
            const filterDiv = document.createElement('div');
            filterDiv.className = 'filter-row';
            filterDiv.id = `filter-${filterId}`;
            
            filterDiv.innerHTML = `
                <select id="stat-${filterId}">
                    ${STAT_OPTIONS.map(opt => `<option value="${opt.value}" data-type="${opt.type}">${opt.label}</option>`).join('')}
                </select>
                <select id="comparison-${filterId}">
                    <option value="=">=</option>
                </select>
                <input type="text" id="value-${filterId}" placeholder="Value">
                <button onclick="removeFilter(${filterId})">Remove</button>
            `;
            
            document.getElementById('activeFilters').appendChild(filterDiv);
            
            // Add event listeners after elements are in DOM
            setTimeout(() => {
                const valueInput = document.getElementById(`value-${filterId}`);
                const comparisonSelect = document.getElementById(`comparison-${filterId}`);
                const statSelect = document.getElementById(`stat-${filterId}`);
                
                if (valueInput) {
                    valueInput.addEventListener('change', applyFilters);
                    valueInput.addEventListener('input', applyFilters);
                }
                if (comparisonSelect) {
                    comparisonSelect.addEventListener('change', applyFilters);
                }
                if (statSelect) {
                    statSelect.addEventListener('change', () => window.updateFilterType(filterId));
                }
            }, 0);
            
            dynamicFilters.push({
                id: filterId,
                stat: 'POS',
                comparison: '=',
                value: '',
                type: 'string'
            });
        };

        window.updateFilterType = function(filterId) {
            const statSelect = document.getElementById(`stat-${filterId}`);
            const selectedOption = statSelect.options[statSelect.selectedIndex];
            const type = selectedOption.dataset.type;
            const valueInput = document.getElementById(`value-${filterId}`);
            const comparisonSelect = document.getElementById(`comparison-${filterId}`);
            
            if (type === 'string') {
                valueInput.type = 'text';
                valueInput.placeholder = 'Value';
                comparisonSelect.innerHTML = '<option value="=">=</option>';
            } else {
                valueInput.type = 'number';
                valueInput.placeholder = 'Value';
                valueInput.step = '0.01';
                comparisonSelect.innerHTML = `
                    <option value=">=">≥</option>
                    <option value="<=">≤</option>
                    <option value="=">=</option>
                    <option value=">">></option>
                    <option value="<"><</option>
                `;
            }
            
            // Add event listener to value input to trigger filter when changed
            valueInput.onchange = applyFilters;
            valueInput.oninput = applyFilters;
            comparisonSelect.onchange = applyFilters;
        };

        window.removeFilter = function(filterId) {
            document.getElementById(`filter-${filterId}`).remove();
            dynamicFilters = dynamicFilters.filter(f => f.id !== filterId);
            applyFilters();
        };

        function getDynamicFilters() {
            const filters = [];
            
            dynamicFilters.forEach(f => {
                const statSelect = document.getElementById(`stat-${f.id}`);
                const comparisonSelect = document.getElementById(`comparison-${f.id}`);
                const valueInput = document.getElementById(`value-${f.id}`);
                
                if (statSelect && comparisonSelect && valueInput && valueInput.value) {
                    const selectedOption = statSelect.options[statSelect.selectedIndex];
                    filters.push({
                        stat: statSelect.value,
                        comparison: comparisonSelect.value,
                        value: valueInput.value,
                        type: selectedOption.dataset.type
                    });
                }
            });
            
            return filters;
        }

        // Load all players to get conference list, then filter
        async function loadPlayers() {
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'players_stats'));
                allPlayers = [];
                const confSet = new Set();
                
                querySnapshot.forEach((doc) => {
                    const player = { id: doc.id, ...doc.data() };
                    allPlayers.push(player);
                    if (player.Conference) confSet.add(player.Conference);
                });
                
                // Sort conferences alphabetically
                conferences = Array.from(confSet).sort();
                
                // Create conference tabs
                createConferenceTabs();
                
                // Load notes and marks
                await loadNotesAndMarks();
                
                // Load ACC by default
                loadConference('ACC');
                
            } catch (error) {
                console.error("Error loading players:", error);
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="20">Error loading data</td></tr>';
            }
        }

        function createConferenceTabs() {
            const tabsDiv = document.getElementById('conferenceTabs');
            tabsDiv.innerHTML = '';
            
            conferences.forEach(conf => {
                const btn = document.createElement('button');
                btn.textContent = conf;
                btn.onclick = () => loadConference(conf);
                if (conf === currentConference) {
                    btn.classList.add('active');
                }
                tabsDiv.appendChild(btn);
            });
        }

        function loadConference(conf) {
            currentConference = conf;
            
            // Update active tab
            document.querySelectorAll('.conference-tabs button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === conf);
            });
            
            // Filter to selected conference
            filteredPlayers = allPlayers.filter(p => p.Conference === conf);
            
            // Apply other filters
            applyFilters();
        }

        async function loadNotesAndMarks() {
            try {
                const notesSnapshot = await window.getDocs(window.collection(window.db, 'player_notes'));
                notesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    playerNotes[doc.id] = data.notes || [];
                    markedPlayers[doc.id] = data.marked || 'none'; // 'none', 'star', or 'x'
                });
            } catch (error) {
                console.error("Error loading notes:", error);
            }
        }

        function applyFilters() {
            const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
            const schoolFilter = document.getElementById('schoolFilter').value.toLowerCase();
            const activeFilters = getDynamicFilters();

            // Start with current conference
            filteredPlayers = allPlayers.filter(p => p.Conference === currentConference);

            // Apply mark filter
            if (markFilter === 'star') {
                filteredPlayers = filteredPlayers.filter(p => markedPlayers[p.playerId] === 'star');
            } else if (markFilter === 'x') {
                filteredPlayers = filteredPlayers.filter(p => markedPlayers[p.playerId] === 'x');
            }

            // Apply name and school filters
            filteredPlayers = filteredPlayers.filter(p => {
                if (nameFilter && !p.Name?.toLowerCase().includes(nameFilter)) return false;
                if (schoolFilter && !p.School?.toLowerCase().includes(schoolFilter)) return false;
                return true;
            });

            // Apply dynamic filters
            activeFilters.forEach(filter => {
                filteredPlayers = filteredPlayers.filter(p => {
                    let playerValue = p[filter.stat];
                    
                    // Special handling for Record - convert to win percentage
                    if (filter.stat === 'Record' && playerValue) {
                        const parts = playerValue.split('-');
                        if (parts.length === 2) {
                            const wins = parseInt(parts[0]);
                            const losses = parseInt(parts[1]);
                            playerValue = wins / (wins + losses);
                        }
                    }
                    
                    // Special handling for Height - convert to inches (e.g., "6' 4\"" -> 76)
                    if (filter.stat === 'Height') {
                        if (playerValue) {
                            const match = playerValue.match(/(\d+)'?\s*(\d+)?/);
                            if (match) {
                                const feet = parseInt(match[1]) || 0;
                                const inches = parseInt(match[2]) || 0;
                                playerValue = feet * 12 + inches;
                            }
                        }
                        
                        // Convert filter value from feet-inches to inches if needed
                        let filterValueInInches = parseFloat(filter.value);
                        if (filter.value.includes("'") || filter.value.includes("'")) {
                            const match = filter.value.match(/(\d+)['']?\s*(\d+)?/);
                            if (match) {
                                const feet = parseInt(match[1]) || 0;
                                const inches = parseInt(match[2]) || 0;
                                filterValueInInches = feet * 12 + inches;
                            }
                        }
                        
                        const numValue = parseFloat(playerValue);
                        if (isNaN(numValue) || isNaN(filterValueInInches)) return false;
                        
                        switch (filter.comparison) {
                            case '>=': return numValue >= filterValueInInches;
                            case '<=': return numValue <= filterValueInInches;
                            case '=': return Math.abs(numValue - filterValueInInches) < 1;
                            case '>': return numValue > filterValueInInches;
                            case '<': return numValue < filterValueInInches;
                            default: return true;
                        }
                    }
                    
                    // Special handling for Weight - extract number from "210 lbs"
                    if (filter.stat === 'Weight' && playerValue) {
                        const match = playerValue.match(/(\d+)/);
                        if (match) {
                            playerValue = parseInt(match[1]);
                        }
                    }
                    
                    if (filter.type === 'string') {
                        // String comparison (case-insensitive equals)
                        return playerValue?.toString().toLowerCase() === filter.value.toLowerCase();
                    } else {
                        // Number comparison
                        const numValue = parseFloat(playerValue);
                        const filterValue = parseFloat(filter.value);
                        
                        if (isNaN(numValue) || isNaN(filterValue)) return false;
                        
                        switch (filter.comparison) {
                            case '>=': return numValue >= filterValue;
                            case '<=': return numValue <= filterValue;
                            case '=': return Math.abs(numValue - filterValue) < 0.01;
                            case '>': return numValue > filterValue;
                            case '<': return numValue < filterValue;
                            default: return true;
                        }
                    }
                });
            });

            sortPlayers(currentSort.key, currentSort.direction);
            renderTable();
        }

        function sortPlayers(key, direction) {
            currentSort = { key, direction };
            
            filteredPlayers.sort((a, b) => {
                let aVal = a[key];
                let bVal = b[key];
                
                // Try to parse as numbers
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    aVal = aNum;
                    bVal = bNum;
                }
                
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            filteredPlayers.forEach(player => {
                const row = document.createElement('tr');
                const markStatus = markedPlayers[player.playerId] || 'none';
                
                if (markStatus === 'star') {
                    row.classList.add('marked-star');
                } else if (markStatus === 'x') {
                    row.classList.add('marked-x');
                }

                // Format function
                const fmt = (val, type) => {
                    if (type === 'percent') {
                        return val ? parseFloat(val).toFixed(1) : '-';
                    } else if (type === 'stat') {
                        return val ? parseFloat(val).toFixed(1) : '0.0';
                    } else {
                        return val || '';
                    }
                };

                // Mark button display
                let markButton = '⚪'; // none
                if (markStatus === 'star') markButton = '⭐';
                if (markStatus === 'x') markButton = '❌';

                row.innerHTML = `
                    <td><button class="mark-button" onclick="toggleMark('${player.playerId}')">${markButton}</button></td>
                    <td>${player.Name || ''}</td>
                    <td>${player.POS || ''}</td>
                    <td>${player.Class || ''}</td>
                    <td>${player.Height || ''}</td>
                    <td>${player.Weight || ''}</td>
                    <td>${player.School || ''}</td>
                    <td>${player.Conference || ''}</td>
                    <td>${player.Record || ''}</td>
                    <td>${player.GP || ''}</td>
                    <td>${fmt(player.MIN, 'stat')}</td>
                    <td>${fmt(player.PPG, 'stat')}</td>
                    <td>${fmt(player.RPG, 'stat')}</td>
                    <td>${fmt(player.APG, 'stat')}</td>
                    <td>${fmt(player.SPG, 'stat')}</td>
                    <td>${fmt(player.BPG, 'stat')}</td>
                    <td>${fmt(player.TOPG, 'stat')}</td>
                    <td>${fmt(player['FG%'], 'percent')}</td>
                    <td>${fmt(player['FT%'], 'percent')}</td>
                    <td>${fmt(player['3P%'], 'percent')}</td>
                    <td><button onclick="openNotes('${player.playerId}')">${(playerNotes[player.playerId] || []).length} notes</button></td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('stats').textContent = `${currentConference}: Showing ${filteredPlayers.length} players`;
        }

        window.toggleMark = async function(playerId) {
            const player = allPlayers.find(p => p.playerId === playerId);
            if (!player) return;

            try {
                const noteDocRef = window.doc(window.db, 'player_notes', playerId);
                const noteDoc = await window.getDoc(noteDocRef);
                
                const currentMark = markedPlayers[playerId] || 'none';
                let newMark = 'none';
                
                // Cycle: none -> star -> x -> none
                if (currentMark === 'none') newMark = 'star';
                else if (currentMark === 'star') newMark = 'x';
                else newMark = 'none';

                await window.setDoc(noteDocRef, {
                    playerId: playerId,
                    notes: noteDoc.exists() ? noteDoc.data().notes || [] : [],
                    marked: newMark
                }, { merge: true });

                markedPlayers[playerId] = newMark;
                renderTable();
            } catch (error) {
                console.error("Error toggling mark:", error);
            }
        };

        window.filterByMark = function(type) {
            markFilter = type;
            
            // Update button styles
            document.getElementById('showAll').style.opacity = type === 'all' ? '1' : '0.5';
            document.getElementById('showStars').style.opacity = type === 'star' ? '1' : '0.5';
            document.getElementById('showXs').style.opacity = type === 'x' ? '1' : '0.5';
            
            applyFilters();
        };

        window.openNotes = function(playerId) {
            selectedPlayer = allPlayers.find(p => p.playerId === playerId);
            if (!selectedPlayer) return;

            document.getElementById('modalTitle').textContent = `${selectedPlayer.Name} - Notes`;
            
            const notesDiv = document.getElementById('existingNotes');
            notesDiv.innerHTML = '';
            
            (playerNotes[playerId] || []).forEach((note, idx) => {
                const noteDiv = document.createElement('div');
                noteDiv.className = 'note';
                noteDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${note.author}</strong> (${new Date(note.timestamp).toLocaleDateString()}):
                            <div class="note-text">${note.text}</div>
                        </div>
                        <div style="display: flex; gap: 5px; flex-shrink: 0;">
                            <button onclick="editNote(${idx})" style="padding: 2px 6px; font-size: 11px;" title="Edit">✏️</button>
                            <button onclick="deleteNote(${idx})" style="padding: 2px 6px; font-size: 11px; background: #dc3545;" title="Delete">✕</button>
                        </div>
                    </div>
                `;
                notesDiv.appendChild(noteDiv);
            });

            document.getElementById('noteText').value = '';
            document.getElementById('notesModal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('notesModal').classList.remove('active');
            selectedPlayer = null;
        };

        window.addNote = async function() {
            if (!selectedPlayer) {
                console.error("No player selected");
                return;
            }
            
            const noteText = document.getElementById('noteText').value.trim();
            if (!noteText) {
                console.error("No note text entered");
                return;
            }

            const noteAuthor = document.getElementById('noteAuthor').value;
            
            console.log("Adding note for player:", selectedPlayer.playerId);
            console.log("Note text:", noteText);
            console.log("Author:", noteAuthor);
            
            try {
                const noteDocRef = window.doc(window.db, 'player_notes', selectedPlayer.playerId);
                const noteDoc = await window.getDoc(noteDocRef);
                
                const newNote = {
                    text: noteText,
                    author: noteAuthor,
                    timestamp: new Date().toISOString()
                };

                const existingNotes = noteDoc.exists() ? noteDoc.data().notes || [] : [];
                
                console.log("Attempting to save note...");
                
                await window.setDoc(noteDocRef, {
                    playerId: selectedPlayer.playerId,
                    notes: [...existingNotes, newNote],
                    marked: markedPlayers[selectedPlayer.playerId] || 'none'
                }, { merge: true });

                console.log("Note saved successfully!");

                playerNotes[selectedPlayer.playerId] = [...existingNotes, newNote];
                
                window.openNotes(selectedPlayer.playerId);
                renderTable();
            } catch (error) {
                console.error("Detailed error adding note:", error);
                console.error("Error code:", error.code);
                console.error("Error message:", error.message);
                alert("Failed to add note: " + error.message);
            }
        };

        window.editNote = async function(noteIndex) {
            if (!selectedPlayer) return;
            
            const currentNotes = playerNotes[selectedPlayer.playerId] || [];
            const noteToEdit = currentNotes[noteIndex];
            
            const newText = prompt("Edit note:", noteToEdit.text);
            if (newText === null || newText.trim() === "") return;
            
            try {
                const noteDocRef = window.doc(window.db, 'player_notes', selectedPlayer.playerId);
                
                currentNotes[noteIndex] = {
                    ...noteToEdit,
                    text: newText.trim(),
                    edited: new Date().toISOString()
                };
                
                await window.setDoc(noteDocRef, {
                    playerId: selectedPlayer.playerId,
                    notes: currentNotes,
                    marked: markedPlayers[selectedPlayer.playerId] || false
                }, { merge: true });

                playerNotes[selectedPlayer.playerId] = currentNotes;
                window.openNotes(selectedPlayer.playerId);
                renderTable();
            } catch (error) {
                console.error("Error editing note:", error);
                alert("Failed to edit note: " + error.message);
            }
        };

        window.deleteNote = async function(noteIndex) {
            if (!selectedPlayer) return;
            
            if (!confirm("Delete this note?")) return;
            
            try {
                const noteDocRef = window.doc(window.db, 'player_notes', selectedPlayer.playerId);
                const currentNotes = playerNotes[selectedPlayer.playerId] || [];
                
                currentNotes.splice(noteIndex, 1);
                
                await window.setDoc(noteDocRef, {
                    playerId: selectedPlayer.playerId,
                    notes: currentNotes,
                    marked: markedPlayers[selectedPlayer.playerId] || false
                }, { merge: true });

                playerNotes[selectedPlayer.playerId] = currentNotes;
                window.openNotes(selectedPlayer.playerId);
                renderTable();
            } catch (error) {
                console.error("Error deleting note:", error);
                alert("Failed to delete note: " + error.message);
            }
        };

        // Event listeners
        document.getElementById('nameFilter').addEventListener('input', applyFilters);
        document.getElementById('schoolFilter').addEventListener('input', applyFilters);

        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sort;
                const direction = currentSort.key === key && currentSort.direction === 'desc' ? 'asc' : 'desc';
                
                document.querySelectorAll('th').forEach(h => {
                    h.textContent = h.textContent.replace(' ↑', '').replace(' ↓', '');
                });
                th.textContent += direction === 'asc' ? ' ↑' : ' ↓';
                
                sortPlayers(key, direction);
                renderTable();
            });
        });

        // Close modal on outside click
        document.getElementById('notesModal').addEventListener('click', (e) => {
            if (e.target.id === 'notesModal') {
                closeModal();
            }
        });

        // Load on page load
        loadPlayers();
    </script>
</body>
</html>
